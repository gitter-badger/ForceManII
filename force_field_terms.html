<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>ForceManII: Force Field Terms in FManII</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ForceManII
   &#160;<span id="projectnumber">0.1</span>
   </div>
   <div id="projectbrief">MM for QM People</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Force Field Terms in <a class="el" href="namespaceFManII.html" title="Namespace for all code associated with ForceManII.">FManII</a> </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The heart and soul of ForceManII is the FFTerm class. This class is what turns a model potential and a set of internal coordinates into an energy or an energy derivative. Extending ForceManII thus comes down to being able to write new model potentials and possibly new internal coordinates. This page aims to elucidate the details of the class and hopefully provide you enough information to design your own FFTerms if you feel so inclined.</p>
<h2>Theoretical Background</h2>
<p>Let's start with some basic theory. For our present purposes, each term in a force field can be thought of as a function that returns an energy given an internal coordinate, <img class="formulaInl" alt="$Q$" src="form_52.png"/> (for the moment, we ignore cross terms that depend on multiple internal coordinates). We usually think of the coordinate as a single number, the distance, the angle, etc. However, when we want derivatives of this energy we want them with respect to Cartesian coordinates. Consequentially it helps to think of this internal coordinate as a function, that when given a vector of Cartesian coordinates, <img class="formulaInl" alt="$\vec{q}$" src="form_53.png"/>, returns a number. Regardless, calling our energy function <img class="formulaInl" alt="$E$" src="form_54.png"/> the first derivative of the energy with respect to <img class="formulaInl" alt="$\vec{q}$" src="form_53.png"/> is readily computed with the chain rule: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \frac{\partial E[Q(\vec{q})]}{\partial \vec{q}}= \frac{\partial E[Q(\vec{q})]}{\partial Q(\vec{q})} \frac{\partial Q(\vec{q})}{\partial \vec{q}}, \]" src="form_55.png"/>
</p>
<p>The second derivative with respect to <img class="formulaInl" alt="$\vec{q}$" src="form_53.png"/> follows from the product rule: </p>
<p class="formulaDsp">
<img class="formulaDsp" alt="\[ \frac{\partial^2 E[Q(\vec{q})]}{\partial\vec{q}^2}= \frac{\partial^2 E[Q(\vec{q})]}{\partial Q(\vec{q})^2} \frac{\partial Q(\vec{q})}{\partial \vec{q}}+ \frac{\partial E[Q(\vec{q})]}{\partial Q(\vec{q})} \frac{\partial Q(\vec{q})^2}{\partial \vec{q}^2} \]" src="form_56.png"/>
</p>
<p> and we ignore higher order derivatives.</p>
<p>What this mathematical model tells us is the final derivate really depends on two things, the derivative of the energy's functional form and the derivative of the coordinate. In fact, we should be able to code these up separtely. This also facilitates code reuse because some energy functions are used in multiple force field terms (<em>e.g.</em> it is not uncommon for both the bond and the angle terms to be harmonic oscillators) and some internal coordinates are associated with multiple force field terms (<em>e.g.</em> both the bond stretching and the Lennard-Jones terms depend on the distance between two points).</p>
<h2>Class Design</h2>
<h3>Decision not to use templates</h3>
<p>At first it seems logical to define FFTerm something like: </p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Model,<span class="keyword">typename</span> IntCoord&gt;</div>
<div class="line"><span class="keyword">class </span>FFTerm{</div>
<div class="line">...</div>
<div class="line">};</div>
</div><!-- fragment --><p> as, afterall, we know at compile time that a harmonic bond stretching term will use a <code>Model=HarmonicOscillator</code> and <code>IntCoord=Distance</code>. This works fine for hard-coded force fields where we know the terms at compile time. The problem is when we have to assemble a force field at runtime. In this case we do not know what terms the force field has. We thus need runtime polymorphism, which excludes the use of templates (without going to something like CRTP, which I avoid as it complicates the API).</p>
<h3>Shared vs. Unique Pointers</h3>
<p>The original motivation for this was I wanted to ensure the FFTerm was usable in an initializer list (and I couldn't seem to get unique_ptrs to work in these lists as the lists seem to use copying).</p>
<h2>Extending ForceManII</h2>
<p>In order to extend ForceManII's capabilities new FFTerms have to be defined and then compiled into your source code. For example, pretending ForceManII does not know how to compute bond-stretching via a harmonic oscillator:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;ForceManII/FManII.hpp&gt;</span> <span class="comment">//Main API of ForceManII</span></div>
<div class="line"></div>
<div class="line"><span class="comment">//Define a model potential that implements a harmonic oscillator by inheritance</span></div>
<div class="line"><span class="keyword">class </span>HarmonicOscillator : <span class="keyword">public</span> <a class="code" href="structFManII_1_1ModelPotential.html">FManII::ModelPotential</a></div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="comment">//Define a default constructor that passes a list of parameter names to the</span></div>
<div class="line">    <span class="comment">//base classs.  In this example &quot;K&quot; will be our force constant</span></div>
<div class="line">    <span class="comment">//and &quot;R0&quot; will be the equilibrium bond length</span></div>
<div class="line">    HarmonicOscillator():</div>
<div class="line">        ModelPotential({Param_t::k,Param_t::r0}){}</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Implment the deriv function (Vector is a typedef of std::vector&lt;double&gt;)</span></div>
<div class="line">    <a class="code" href="namespaceFManII.html#aa967833d4468e3e3b264dc76116b5891" title="Type of a quantity we are treating as a mathematical vector.">FManII::Vector</a> <a class="code" href="structFManII_1_1ModelPotential.html#a13355762cbaf9fd6994047b524b7a863" title="The function to override so it returns your derivative.">deriv</a>(<span class="keywordtype">size_t</span> order,</div>
<div class="line">                         <span class="keyword">const</span> std::map&lt;std::string,FManII::Vector&gt;&amp; in_params,</div>
<div class="line">                         <span class="keyword">const</span> std::vector&lt;FManII::Vector&gt;&amp; in_coords)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">//Normally this would be implemented in a .cpp file, but for brevity we</span></div>
<div class="line">        <span class="comment">//are doing it in the header and ignoring all energy derivatives</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">//One element long vector initialized to 0 that will be our energy</span></div>
<div class="line">        std::vector&lt;double&gt; return_value(1,0.0);</div>
<div class="line">        <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i=0; i&lt;in_coords[0].size();++i)</div>
<div class="line">        {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">double</span> qi=(in_coords[0][i]-in_params.at(Param_t::r0)[i]);</div>
<div class="line">            return_value[0]+=0.5*in_params.at(Param_t::k)[i]*qi*qi;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> return_value;</div>
<div class="line">    }<span class="comment">//End deriv</span></div>
<div class="line">};<span class="comment">//End Harmonic Oscillator class</span></div>
</div><!-- fragment --><p>Describe how to derive from the InternalCoordinates class </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
